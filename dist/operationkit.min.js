!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("operationkit",[],t):"object"==typeof exports?exports.operationkit=t():e.operationkit=t()}(window,function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)}([function(e,t,i){const n=i(2),r=i(7),{OperationEvent:s}=i(3),{QueuePriority:o}=i(1),{copyArray:u,isObjectEmpty:h}=i(4);e.exports={Operation:class extends n{constructor(e){super(),e||(e=r()),this.id=e,this.name=null,this.completionCallback=null,this.map={},this.isExecuting=!1,this.error=!0,this.promise=null,this.runPromise=null,this._dependencies=[],this._done=!1,this._isInQueue=!1,this._canStart=!1,this._cancelled=!1,this._queuePriority=o.normal,this._resolve=null,this._reject=null}get isFinished(){return this._done}get isCancelled(){return this._cancelled}set isInQueue(e){this._isInQueue=e}get isInQueue(){return this._isInQueue}set queuePriority(e){this.isExecuting||this.isCancelled||this.isFinished||o.isValid(e)&&(this._queuePriority=e)}get queuePriority(){return this._queuePriority}set dependencies(e){this.isExecuting||this.isCancelled||this.isFinished||(this._dependencies=e)}get dependencies(){return this.isExecuting||this.isCancelled||this.isFinished?u(this._dependencies):this._dependencies}cancel(){this._cancelled=!0,Promise.resolve(this.promise),this.emit(s.CANCEL,this),this._resolve&&this._resolve()}done(){this._done=!0,this.completionCallback&&this.completionCallback(this),this.emit(s.DONE,this),this._resolve&&this._resolve(this.result)}isDone(){return this._done}addDependency(e){this._dependencies.push(e)}removeDependency(e){this._dependencies=this._dependencies.filter(t=>t.id!==e.id)}async run(){throw new Error("run function must be implemented")}start(){return this.isExecuting||this.isCancelled||this.isFinished?this.promise:(this.promise&&!this._canStart?this._preProcessStart():this.promise&&this._canStart?this._isInQueue?this.emit(s.READY,this):this.main():this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t,this._preProcessStart()}),this.promise)}main(){this.isExecuting=!0,this.emit(s.START,this),this.runPromise=this.run().then(e=>{this.result=e,this.done()}).catch(e=>{this.isExecuting=!1,this.error=!0,this.emit(s.ERROR,{err:e,operation:this}),this.emit(s.DONE,this),this._reject&&this._reject()})}_preProcessStart(){this._createMap(),this._canStart&&(this._isInQueue?this.emit(s.READY,this):this.main())}_createMap(){this._dependencies.length?this._dependencies.forEach(e=>{this.map[e.id]=!0,e.on(s.DONE,this._onDependantOperationDone.bind(this)),e.start()}):this._canStart=!0}_onDependantOperationDone(e){delete this.map[e.id],this._tryStart()}_tryStart(){this.isExecuting||this.isCancelled||this.isFinished||h(this.map)&&(this._canStart=!0,this.isInQueue?this.emit(s.READY,this):this.start())}}}},function(e,t){e.exports={QueuePriority:new class{get veryLow(){return 0}get low(){return 1}get normal(){return 2}get high(){return 3}get veryHigh(){return 4}isValid(e){return e>=this.veryLow&&e<=this.veryHigh}}}},function(e,t,i){"use strict";var n,r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function u(){u.init.call(this)}e.exports=u,u.EventEmitter=u,u.prototype._events=void 0,u.prototype._eventsCount=0,u.prototype._maxListeners=void 0;var h=10;function a(e){return void 0===e._maxListeners?u.defaultMaxListeners:e._maxListeners}function p(e,t,i,n){var r,s,o,u;if("function"!=typeof i)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i);if(void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),s=e._events),o=s[t]),void 0===o)o=s[t]=i,++e._eventsCount;else if("function"==typeof o?o=s[t]=n?[i,o]:[o,i]:n?o.unshift(i):o.push(i),(r=a(e))>0&&o.length>r&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=o.length,u=h,console&&console.warn&&console.warn(u)}return e}function c(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,s(this.listener,this.target,e))}.bind(n);return r.listener=i,n.wrapFn=r,r}function l(e,t,i){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(r):f(r,r.length)}function d(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function f(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");h=e}}),u.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},u.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},u.prototype.getMaxListeners=function(){return a(this)},u.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var u=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw u.context=o,u}var h=r[e];if(void 0===h)return!1;if("function"==typeof h)s(h,this,t);else{var a=h.length,p=f(h,a);for(i=0;i<a;++i)s(p[i],this,t)}return!0},u.prototype.addListener=function(e,t){return p(this,e,t,!1)},u.prototype.on=u.prototype.addListener,u.prototype.prependListener=function(e,t){return p(this,e,t,!0)},u.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,c(this,e,t)),this},u.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,c(this,e,t)),this},u.prototype.removeListener=function(e,t){var i,n,r,s,o;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){o=i[s].listener,r=s;break}if(r<0)return this;0===r?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,r),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},u.prototype.off=u.prototype.removeListener,u.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,s=Object.keys(i);for(n=0;n<s.length;++n)"removeListener"!==(r=s[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},u.prototype.listeners=function(e){return l(this,e,!0)},u.prototype.rawListeners=function(e){return l(this,e,!1)},u.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},u.prototype.listenerCount=d,u.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(e,t){e.exports={OperationEvent:new class{get START(){return"start"}get READY(){return"ready"}get DONE(){return"done"}get CANCEL(){return"cancel"}get ERROR(){return"e"}}}},function(e,t){e.exports={copyArray:e=>e.map(e=>Object.assign(Object.create(e),e)),copyObject:e=>Object.assign(Object.create(e),e),isObjectEmpty:e=>{for(const t in e)return!1;return!0}}},function(e,t,i){const n=i(2),{CircularOperationValidator:r}=i(10),{QueuePriority:s}=i(1),{QueueEvent:o}=i(11),{isObjectEmpty:u}=i(4);e.exports={OperationQueue:class extends n{constructor(){super(),this.map={},this.operations=[],this._processedOperations=[],this.resolve=null,this.completionCallback=null,this.maximumConcurentOperations=10,this.readyQueueMap={},this.readyQueue=[],this.runningQueueMap={},this.runningQueue=[],this.queues={[s.veryHigh]:[],[s.high]:[],[s.normal]:[],[s.low]:[],[s.veryLow]:[]}}get isExecuting(){return!u(this.map)}done(){this.completionCallback&&this.completionCallback(),this.resolve()}addOperation(e){this.addOperations([e])}addOperations(e){return this.operations=this.operations.concat(e),this._preProcessOperations(e),this._processedOperations=this._processedOperations.concat(this.operations),this._begin(),this.promise}pause(){this._paused||(this._paused=!0,this.emit(o.PAUSED,this))}resume(){this._paused&&(this._paused=!1,this.emit(o.RESUMED,this),this._checkNextOperation())}get isPaused(){return this._paused}_preProcessOperations(e){try{new r(e)}catch(e){throw e}e.forEach(e=>{this.map[e.id]||(this.map[e.id]=!0,e.isInQueue=!0,this._bindOperation(e)),this._preProcessOperations(e.dependencies)})}_bindOperation(e){e.on("start",this._onOperationStart.bind(this)),e.on("ready",this._onOperationReady.bind(this)),e.on("cancel",this._onOperationCancel.bind(this)),e.on("done",this._onOperationDone.bind(this))}_unbindOperation(e){e.off("start",this._onOperationStart.bind(this)),e.off("ready",this._onOperationReady.bind(this)),e.off("cancel",this._onOperationCancel.bind(this)),e.off("done",this._onOperationDone.bind(this))}_begin(){this.promise?this._startOperations():this.promise=new Promise((e,t)=>{this.resolve=e,this._startOperations()})}_startOperations(){this._processedOperations.forEach(e=>{this._startOperation(e)})}_startOperation(e){e.start()}_onOperationStart(e){}_onOperationReady(e){this.readyQueueMap[e.id]=!0,this.queues[e.queuePriority].push(e),this._checkNextOperation()}_onOperationDone(e){this._unbindOperation(e),this.runningQueue=this.runningQueue.filter(t=>t.id!==e.id),delete this.map[e.id],delete this.runningQueueMap[e.id],u(this.map)?(this.emit(o.DONE,this),this.done()):this._checkNextOperation()}_checkNextOperation(){if(!this._paused&&this.runningQueue.length<this.maximumConcurentOperations&&this.hasOperations()){const e=this.getNextOperation();(!e||e.isExecuting)&&e.isCancelled&&this.runningQueueMap[e.id]||(this.runningQueueMap[e.id]=!0,this.runningQueue.push(e),e.main(),this._checkNextOperation())}}hasOperations(){return!!(this.queues[s.veryHigh].length+this.queues[s.high].length+this.queues[s.normal].length+this.queues[s.low].length+this.queues[s.veryLow].length)}getNextOperation(){let e=null;return this.queues[s.veryHigh].length?e=this.queues[s.veryHigh].pop():this.queues[s.high].length?e=this.queues[s.high].pop():this.queues[s.normal].length?e=this.queues[s.normal].pop():this.queues[s.low].length?e=this.queues[s.low].pop():this.queues[s.veryLow].length?e=this.queues[s.veryLow].pop():e}_onOperationCancel(e){delete this.map[e.id],delete this.queues[e.queuePriority],this.operations=this.operations.filter(t=>t.id!==e.id),u(this.map)&&(this.emit(o.DONE,this),this.done())}}}},function(e,t,i){const{Operation:n}=i(0),{OperationQueue:r}=i(5),{BlockOperation:s}=i(12),{GroupOperation:o}=i(13),{OperationEvent:u}=i(3),{QueuePriority:h}=i(1);e.exports={Operation:n,OperationQueue:r,BlockOperation:s,GroupOperation:o,OperationEvent:u,QueuePriority:h}},function(e,t,i){var n=i(8),r=i(9);e.exports=function(e,t,i){var s=t&&i||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||n)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var u=0;u<16;++u)t[s+u]=o[u];return t||r(o)}},function(e,t){var i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(i){var n=new Uint8Array(16);e.exports=function(){return i(n),n}}else{var r=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),r[t]=e>>>((3&t)<<3)&255;return r}}},function(e,t){for(var i=[],n=0;n<256;++n)i[n]=(n+256).toString(16).substr(1);e.exports=function(e,t){var n=t||0,r=i;return[r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]]].join("")}},function(e,t){class i extends Error{constructor(e){super(),this.message=e}}e.exports={CircularOperationValidator:class{constructor(e){this.operations=e,this._checkCircular()}_checkCircular(){this.operations.forEach(e=>{e.dependencies.forEach(t=>{let i={};i[e.id]=Object.keys(i).length,this._verifyOpMap(t,i),this._checkDependencies(t,i)})})}_checkDependencies(e,t){e.dependencies.forEach(e=>{let i=JSON.parse(JSON.stringify(t));this._verifyOpMap(e,i),this._checkDependencies(e,i)})}_verifyOpMap(e,t){void 0!==t[e.id]&&this._throwError(e,t),t[e.id]=Object.keys(t).length}_throwError(e,t){Object.keys(t);let n={};for(let e in t)n[t[e]]=e;throw(n=Object.values(n)).push(e.id),new i(`Circular: ${n}`)}}}},function(e,t){e.exports={QueueEvent:new class{get DONE(){return"done"}get PAUSED(){return"paused"}get RESUMED(){return"resumed"}}}},function(e,t,i){const{Operation:n}=i(0);e.exports={BlockOperation:class extends n{constructor(){let e,t;const i=arguments[0];if("number"==typeof i){e=i;const n=arguments[1];"function"==typeof n&&(t=n)}else{if("function"!=typeof i)throw new Error("Wrong arguments passed: missing ID and/or function");t=i}super(e),this.blocks=[t]}run(){const e=[];return this.blocks.forEach(t=>{e.push(t(this))}),Promise.all(e)}addBlock(e){"function"==typeof e&&this.blocks.push(e)}}}},function(e,t,i){const{Operation:n}=i(0),{OperationQueue:r}=i(5);e.exports={GroupOperation:class extends n{constructor(){super(),this.queue=new r,this.operations=[]}async run(){return await this.queue.addOperations(this.operations),this.operations.reduce((e,t)=>(e.push(t.result),e),[])}async start(){return this.dependencies=[],super.start()}addOperation(e){this.operations.push(e),this.dependencies=[]}addOperations(e){this.operations=this.operations.concat(e),this.dependencies=[]}}}}])});
//# sourceMappingURL=operationkit.min.js.map